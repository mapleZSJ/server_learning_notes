## Redis持久化方式

Redis 的读写操作都是在内存中，但是当 Redis 重启后，内存中的数据就会丢失；  <br/>
为了保证内存中的数据不会丢失，Redis 实现了数据持久化的机制，这个机制会把数据存储到磁盘，这样在 Redis 重启就能够从磁盘中恢复原有的数据。

<br>

**1 AOF 日志**：每执行一条写操作命令，就把该命令以追加的方式写入到一个文件里【Redis 重启时，会读取该文件记录的命令，然后逐一执行命令的方式来进行数据恢复】

有3 种写回硬盘的策略， 在 **Redis.conf 配置文件中的 appendfsync 配置项**可以有以下 3 种参数可填： <br/>
**Always**，每次写操作命令执行完后，同步将 AOF 日志数据写回硬盘【可靠性高，最大程度保证数据不丢失，性能开销大】；   <br/>
**Everysec**，每次写操作命令执行完后，先将命令写入到 AOF 文件的内核缓冲区，然后每隔一秒将缓冲区里的内容写回到硬盘【性能适中，宕机时丢失一秒内的数据】；   <br/>
**No**，意味着不由 Redis 控制写回硬盘的时机，转交给操作系统控制写回的时机，也就是每次写操作命令执行完后，先将命令写入到 AOF 文件的内核缓冲区，再由操作系统决定何时将缓冲区内容写回硬盘【性能好，宕机时丢失的数据可能会很多】。   <br/>


AOF 日志记录的是操作命令，所以用 AOF 方法做故障恢复时，需要全量把日志都执行一遍，一旦 AOF 日志非常多，势必会造成 Redis 的恢复操作缓慢。


<br>

**2 RDB 快照**：将某一时刻的内存数据，以二进制的方式写入磁盘

Redis 恢复数据时， RDB 恢复数据的效率会比 AOF 高些，因为直接将 RDB 文件读入内存就可以，不需要像 AOF 那样还需要额外执行操作命令的步骤才能恢复数据。

Redis 提供了两个命令来生成 RDB 文件，分别是 save 和 bgsave，他们的区别就在于是否在「主线程」里执行：   <br/>
**save 命令**，会在主线程生成 RDB 文件，由于和执行操作命令在同一个线程，所以如果写入 RDB 文件的时间太长，会阻塞主线程；   <br/>
**bgsave 命令**，会创建一个子进程来生成 RDB 文件，这样可以避免主线程的阻塞；   <br/>
